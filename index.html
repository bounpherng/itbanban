<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <!-- Adjusted viewport for better mobile fitting -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Salary Calculator 2026</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#009688">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@300;400;500;600;700&family=Phetsarath&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- App Styles (Native Feel) --- */
        :root {
            --primary: #009688;
            --primary-dark: #00796b;
            --pension: #795548; /* Brown for Pension */
            --allowance: #673ab7; /* Purple for Allowance */
            --accent: #ffab00;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #263238;
            --text-light: #78909c;
            --border-radius: 16px;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
            --safe-area-bottom: env(safe-area-inset-bottom);
            --nav-height: 70px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Noto Sans Lao', 'Phetsarath', sans-serif;
            background-color: #e0e0e0; /* Desktop Background Color */
            color: var(--text-main);
            /* Fixed: Use 100dvh to handle mobile address bars correctly */
            height: 100vh;
            height: 100dvh; 
            display: flex; /* Flexbox for centering */
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Prevent body scroll */
        }

        /* --- MOBILE CONTAINER SIMULATOR --- */
        #app-container {
            width: 100%;
            max-width: 480px; /* Limit width like a phone */
            height: 100%;
            background-color: var(--bg-color); /* App Background */
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0,0,0,0.2); /* Shadow for depth */
            overflow: hidden;
        }

        /* App Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 15px 20px 25px 20px;
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,150,136,0.2);
            position: relative;
            z-index: 10;
            flex-shrink: 0; /* Don't shrink header */
            transition: background 0.3s;
        }
        
        /* Pension Theme */
        body.pension-mode .app-header {
            background: linear-gradient(135deg, var(--pension), #5d4037);
        }
        body.pension-mode .btn-calc {
            background: var(--pension);
        }

        /* Allowance Theme */
        body.allowance-mode .app-header {
            background: linear-gradient(135deg, var(--allowance), #512da8);
        }
        body.allowance-mode .btn-calc {
            background: var(--allowance);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .app-logo {
            width: 45px;
            height: 45px;
            background: white;
            border-radius: 50%;
            padding: 2px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            object-fit: contain;
        }

        .app-title h1 {
            font-size: 1.1rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .app-title p {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* Scrollable Content Area */
        .content-area {
            flex: 1; /* Take remaining space */
            overflow-y: auto; /* Scroll inside this area */
            padding: 0 15px;
            margin-top: -15px;
            padding-top: 25px;
            /* Space for nav - Increased slightly to prevent overlap */
            padding-bottom: calc(var(--nav-height) + 30px + var(--safe-area-bottom)); 
            position: relative;
            z-index: 5;
            scroll-behavior: smooth;
        }
        
        /* Hide Scrollbar for cleaner look */
        .content-area::-webkit-scrollbar {
            width: 4px;
        }
        .content-area::-webkit-scrollbar-thumb {
            background-color: rgba(0,0,0,0.2);
            border-radius: 4px;
        }

        /* Pages */
        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0,0,0,0.02);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #eceff1;
        }

        .card-header i {
            color: var(--primary);
            font-size: 1.1rem;
            background: #e0f2f1;
            padding: 8px;
            border-radius: 10px;
        }
        
        body.pension-mode .card-header i {
            color: var(--pension);
            background: #efebe9;
        }

        body.allowance-mode .card-header i {
            color: var(--allowance);
            background: #ede7f6;
        }

        .card-title {
            font-weight: 600;
            color: var(--text-main);
            font-size: 1rem;
        }

        /* --- UPDATED HOME PAGE STYLES --- */
        .home-banner {
            text-align: center;
            padding: 25px 20px;
            background: white;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        .home-banner::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }

        .home-banner h2 {
            color: var(--primary);
            font-size: 1.3rem;
            margin-bottom: 5px;
            margin-top: 10px;
        }

        /* Visitor Counter Styles */
        .visitor-counter {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 6px 15px;
            background: #f1f8e9;
            color: #33691e;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid #c5e1a5;
        }
        .visitor-counter i {
            color: #558b2f;
        }

        .info-list {
            list-style: none;
            padding: 0;
        }
        
        .info-list li {
            position: relative;
            padding-left: 25px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #455a64;
        }
        
        .info-list li::before {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            left: 0;
            top: 2px;
            color: var(--primary);
            font-size: 0.8rem;
        }

        .formula-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.85rem;
        }
        
        .formula-table th {
            background: #f8fafc;
            text-align: left;
            padding: 8px;
            color: #475569;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .formula-table td {
            padding: 8px;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
        }
        
        .code-block {
            background: #263238;
            color: #eceff1;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.8rem;
            margin: 10px 0;
            overflow-x: auto;
        }

        .disclaimer-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.85rem;
            color: #e65100;
            line-height: 1.5;
        }

        .footer-credit {
            text-align: center;
            padding: 20px 15px;
            background-color: #f8fafc;
            border-top: 1px solid #e2e8f0;
            font-family: 'Phetsarath OT', sans-serif;
            color: #64748b;
            font-size: 0.85rem;
            line-height: 1.5;
            margin-top: 20px;
            border-radius: 12px;
        }

        .footer-icon {
            font-size: 1.4rem;
            color: #3b82f6;
            margin-bottom: 8px;
        }

        .footer-dev {
            border-top: 1px dashed #cbd5e1;
            padding-top: 10px;
            margin-top: 10px;
            color: #334155;
        }

        .footer-dev strong {
            font-weight: 600;
            color: #1e293b;
        }

        .dev-phone {
            display: inline-block;
            margin-top: 4px;
            color: #22c55e;
            font-weight: 600;
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .dev-phone:hover {
            color: #15803d;
        }
        /* ------------------------------------- */

        .home-info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            border-left: 4px solid #2196f3;
            line-height: 1.5;
        }

        /* Form Elements */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group.full {
            grid-column: span 2;
        }

        label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .required::after {
            content: "*";
            color: #ef5350;
            margin-left: 2px;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 12px;
            border: 1px solid #cfd8dc;
            background: #fff;
            font-family: inherit;
            font-size: 1rem;
            color: var(--text-main);
            outline: none;
            transition: border-color 0.2s;
            -webkit-appearance: none;
        }

        input:focus, select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,150,136,0.1);
        }

        input[readonly] {
            background-color: #f1f8e9;
            border-color: #c5e1a5;
            color: #33691e;
            font-weight: 600;
        }

        /* Bottom Navigation Bar */
        .bottom-nav {
            position: absolute; /* Fixed: Absolute is fine if container handles it */
            bottom: 0;
            left: 0;
            width: 100%;
            height: calc(var(--nav-height) + var(--safe-area-bottom));
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: var(--safe-area-bottom);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
            z-index: 1000; /* Fixed: Increased Z-Index to ensure visibility */
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #90a4ae;
            font-size: 0.7rem; /* Smaller font for 5 items */
            cursor: pointer;
            transition: all 0.2s;
            height: 100%;
            padding-top: 10px;
        }

        .nav-item i {
            font-size: 1.3rem;
            margin-bottom: 4px;
        }

        .nav-item.active {
            color: var(--primary);
        }
        
        .nav-item.active i {
            transform: translateY(-2px);
        }
        
        /* Pension Active Color */
        .nav-item#nav-pension.active {
            color: var(--pension);
        }

        /* Allowance Active Color */
        .nav-item#nav-allowance.active {
            color: var(--allowance);
        }

        /* Action Buttons inside Form */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 40px;
        }

        .btn {
            border: none;
            padding: 15px;
            border-radius: 14px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
        }

        .btn-reset {
            background: #eceff1;
            color: #546e7a;
        }

        .btn-calc {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(0,150,136,0.4);
            flex: 1.5;
        }

        /* Slip Modal & Layout */
        .modal-overlay {
            position: absolute; /* Relative to app-container */
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 2000; /* Ensure modal is above nav */
            display: none;
            justify-content: center;
            align-items: flex-end;
        }

        .modal-overlay.active { display: flex; animation: fadeInModal 0.3s; }

        .modal-content {
            background: #fff;
            width: 100%;
            max-width: 600px;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }

        /* DETAILED SLIP DESIGN */
        .slip-paper {
            background: white;
            padding: 40px 30px;
            position: relative;
            color: #333;
            font-family: 'Noto Sans Lao', sans-serif;
        }

        .slip-header-official {
            text-align: center;
            margin-bottom: 25px;
            line-height: 1.4;
        }
        .slip-header-official h4 {
            font-size: 1rem;
            font-weight: normal;
            margin: 0;
        }
        .slip-header-official h3 {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 5px 0 0 0;
            text-transform: uppercase;
        }
        .slip-divider-line {
            border-bottom: 2px solid #000;
            margin: 10px auto;
            width: 50%;
        }

        .slip-meta {
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
        }
        .slip-meta-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .slip-section-title {
            font-weight: 700;
            font-size: 0.95rem;
            margin-top: 15px;
            margin-bottom: 8px;
            border-bottom: 1px dashed #bbb;
            padding-bottom: 3px;
            color: #000;
            text-transform: uppercase;
        }

        .slip-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: #444;
        }
        .slip-item.sub {
            padding-left: 15px;
            color: #666;
            font-size: 0.85rem;
        }
        .slip-item.total-sub {
            font-weight: 600;
            color: #000;
            border-top: 1px dotted #ccc;
            padding-top: 4px;
            margin-top: 4px;
        }

        .val { font-family: 'Courier New', monospace; font-weight: 600; }
        .val.minus { color: #d32f2f; }
        .val.plus { color: #2e7d32; }

        .slip-grand-total {
            margin-top: 25px;
            border: 2px solid #000;
            padding: 15px;
            text-align: center;
            background: #fafafa;
        }
        .slip-grand-total .label { font-size: 0.9rem; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .slip-grand-total .amount { font-size: 1.8rem; font-weight: 800; color: #000; }

        .slip-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 0.75rem;
            color: #888;
            font-style: italic;
        }

        .modal-actions {
            padding: 20px;
            background: white;
            border-top: 1px solid #f0f0f0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn-close { background: #ffebee; color: #d32f2f; }
        .btn-save { background: #e3f2fd; color: #1976d2; }
        
        .hidden { display: none; }
        
        /* Install Button for PWA */
        #install-prompt {
            display: none;
            background: #263238;
            color: white;
            padding: 10px 20px;
            margin: 0 15px 15px 15px;
            border-radius: 12px;
            align-items: center;
            justify-content: space-between;
            font-size: 0.9rem;
        }
        #install-prompt button {
            background: var(--primary);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            margin-left: 10px;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <!-- APP CONTAINER (Mobile Simulator) -->
    <div id="app-container">

        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <!-- Uses icon-512.png if available, otherwise fallback to URL for display -->
                <img src="icon-512.png" onerror="this.src='https://raw.githubusercontent.com/bounpherng/IT-BANBAN/main/icon-512.png'" alt="Logo" class="app-logo">
                <div class="app-title">
                    <h1 id="headerTitle">IT-BANBAN</h1>
                    <p>ເຄື່ອງຄຳນວນເງິນເດືອນ,ອຸດໜຸນ ອປຊ 2026</p>
                </div>
            </div>
        </header>

        <!-- Scrollable Content -->
        <div class="content-area">
            
            <!-- PWA Install Prompt -->
            <div id="install-prompt">
                <span>ຕິດຕັ້ງແອັບໄວ້ໃນມືຖືເພື່ອງ່າຍຕໍ່ການໃຊ້ງານ</span>
                <button onclick="installPWA()">ຕິດຕັ້ງ</button>
            </div>
            
            <!-- PAGE 1: HOME -->
            <div id="page-home" class="page active">
                <div class="home-banner">
                    <i class="fas fa-calculator" style="font-size: 50px; color: var(--primary);"></i>
                    <h2>IT-BANBAN Calculator</h2>
                    <p>ລະບົບຄຳນວນເງິນເດືອນ ແລະ ເງິນອຸດໜູນ</p>
                    
                    <!-- UPDATED: Visitor Counter using Fetch -->
                    <div class="visitor-counter">
                        <i class="fas fa-users"></i>
                        <span id="visitor-text">ກຳລັງໂຫຼດຂໍ້ມູນ...</span>
                    </div>
                </div>

                <!-- Regulation & Features List -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-book"></i>
                        <span class="card-title">ຄຳແນະນຳ ເລກທີ 4904/ກງ ລົງວັນທີ 26 ທັນວາ 2025</span>
                    </div>
                    <div class="regulation-text" style="font-size: 0.9rem; line-height: 1.6; color: #455a64;">
                        
                        <!-- Added Link Button -->
                        <div style="margin-bottom: 12px; text-align: center;">
                             <a href="https://drive.google.com/file/d/1OTFUa_qLxDXYKHwLed8kLlwit8KVVT3A/view?usp=sharing" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; background: #e0f2f1; padding: 10px 18px; border-radius: 20px; border: 1px solid #b2dfdb; transition: all 0.2s;">
                                <i class="fas fa-file-pdf"></i> ເບິ່ງເອກະສານລະອຽດ
                             </a>
                        </div>
                        
                        <ul class="info-list">
                            <li><strong>ເງິນເດືອນພື້ນຖານ:</strong> ອີງຕາມຊັ້ນ-ຂັ້ນ ແລະ ດັດສະນີ (ຄູນ 9,500 ກີບ)</li>
                            <li><strong>ເງິນດັດສົມປີການ:</strong> ຕາມອາຍຸການຕົວຈິງ (1-50 ປີ)</li>
                            <li><strong>ເງິນຕຳແໜ່ງ:</strong> ຮອງຮັບທຸກຕຳແໜ່ງບໍລິຫານ ແລະ ວິຊາການ</li>
                            <li><strong>ອຸດໜູນຄູ:</strong> ຮອງຮັບ 10-30%, ຫ້ອງຄວບ ແລະ ວິຊາການຄູ</li>
                        </ul>
                    </div>
                </div>

                <!-- Formulas -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-square-root-alt"></i>
                        <span class="card-title">ສູດການຄຳນວນປີການ</span>
                    </div>
                    <table class="formula-table">
                        <thead>
                            <tr>
                                <th>ປີການ</th>
                                <th>ສູດການຄິດໄລ່</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>≤ 5 ປີ</td>
                                <td>ປີການ × 10,000</td>
                            </tr>
                            <tr>
                                <td>6-15 ປີ</td>
                                <td>50,000 + ((ປີ - 5) × 20,000)</td>
                            </tr>
                            <tr>
                                <td>16-25 ປີ</td>
                                <td>250,000 + ((ປີ - 15) × 30,000)</td>
                            </tr>
                            <tr>
                                <td>> 25 ປີ</td>
                                <td>550,000 + ((ປີ - 25) × 40,000)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pension Formula -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-percent"></i>
                        <span class="card-title">ສູດຄິດໄລ່ບຳນານ</span>
                    </div>
                    <div class="code-block">
                        ບຳນານ = (ເງິນເດືອນພື້ນຖານ + ປີການ + ຕຳແໜ່ງ + ອຸດໜູນອາຊີບ) × %ບຳນານ
                    </div>
                    <ul class="info-list" style="margin-top:10px;">
                        <li>ຫັກປະກັນສຸຂະພາບ: 0.625%</li>
                        <li>ນະໂຍບາຍຊ່ວຍໜູນ: ຖ້າຕ່ຳກວ່າ 3,000,000 ກີບ ລະບົບປັບອັດຕະໂນມັດ</li>
                    </ul>
                </div>

                <!-- Disclaimer -->
                <div class="disclaimer-box">
                    <strong>⚠️ ຂໍ້ຈຳກັດຄວາມຮັບຜິດຊອບ:</strong><br>
                    ລະບົບນີ້ສ້າງຂຶ້ນເພື່ອອຳນວຍຄວາມສະດວກໃນການຄິດໄລ່ເບື້ອງຕົ້ນເທົ່ານັ້ນ. ຜົນການຄິດໄລ່ອາດມີຄວາມຄາດເຄື່ອນເລັກນ້ອຍ ຂຶ້ນກັບການຕີຄວາມໝາຍ. ກະລຸນາກວດສອບກັບພາກສ່ວນການເງິນເພື່ອຄວາມຖືກຕ້ອງສູງສຸດ.
                </div>
                
                <!-- Footer Credit -->
                <div class="footer-credit">
                    <div class="footer-icon">
                        <i class="fas fa-code"></i>
                    </div>

                    <div class="footer-desc">
                        Created with ❤️ for Lao Civil Servants<br>
                        ພັດທະນາໂດຍ: <strong>Bounpherng PHATXAIYAPHOOM</strong> &copy; 2026
                    </div>

                    <div class="footer-dev">
                        <a href="https://wa.me/8562091270509" target="_blank" class="dev-phone">
                            <i class="fab fa-whatsapp"></i> 020 9127 0509
                        </a>
                    </div>
                </div>
                
                <div style="height: 40px;"></div>
            </div>

            <!-- PAGE 2: CALCULATOR (Shared for Teacher & Civil) -->
            <div id="page-calc" class="page">
                <form id="salaryForm" onsubmit="return false;">
                    <!-- Teacher Mode Header -->
                    <div id="teacherModeBanner" class="home-info-box hidden" style="background: #e8f5e9; border-color: #4caf50; color: #2e7d32;">
                        <i class="fas fa-chalkboard-teacher"></i> ທ່ານພວມຢູ່ໃນໂຫມດ: <strong>ຄຳນວນເງິນເດືອນຄູ</strong>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-user"></i>
                            <span class="card-title">ຂໍ້ມູນທົ່ວໄປ</span>
                        </div>
                        <div class="form-group">
                            <label class="required">ຊື່ ແລະ ນາມສະກຸນ</label>
                            <input type="text" id="fullName" placeholder="ປ້ອນຊື່ຂອງທ່ານ..." required>
                        </div>
                    </div>

                    <!-- Position Info -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-briefcase"></i>
                            <span class="card-title">ຂໍ້ມູນຕຳແໜ່ງ & ຊັ້ນຂັ້ນ</span>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="required">ຊັ້ນ</label>
                                <select id="classSelect" onchange="updateLevels()" required>
                                    <option value="">ເລືອກ...</option>
                                    <option value="1">ຊັ້ນ 1</option>
                                    <option value="2">ຊັ້ນ 2</option>
                                    <option value="3">ຊັ້ນ 3</option>
                                    <option value="4">ຊັ້ນ 4</option>
                                    <option value="5">ຊັ້ນ 5</option>
                                    <option value="6">ຊັ້ນ 6</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="required">ຂັ້ນ</label>
                                <select id="levelSelect" onchange="updateIndex()" required disabled>
                                    <option value="">...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ດັດສະນີ (Auto)</label>
                                <input type="text" id="indexDisplay" readonly placeholder="0">
                            </div>
                            <div class="form-group">
                                <label class="required">ເປີເຊັນໄດ້ຮັບ (%)</label>
                                <!-- FIXED: Input restricted to numbers only -->
                                <input type="tel" id="percentage" value="100" inputmode="numeric" class="money-input">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="required">ປີການ (ປີ)</label>
                            <!-- FIXED: Input restricted to numbers only -->
                            <input type="tel" id="yearsService" value="0" inputmode="numeric" class="money-input">
                        </div>
                        <div class="form-group">
                            <label>ເງິນຕຳແໜ່ງ</label>
                            <select id="positionMoney">
                                <option value="0">ບໍ່ມີ / ພະນັກງານ 95</option>
                                <option value="900000">ວິຊາການ - 900,000</option>
                                <option value="1100000">ບໍລິຫານ 8 - 1,100,000</option>
                                <option value="1300000">ບໍລິຫານ 7 - 1,300,000</option>
                                <option value="1500000">ບໍລິຫານ 6 - 1,500,000</option>
                                <option value="1700000">ບໍລິຫານ 5 - 1,700,000</option>
                                <option value="1900000">ບໍລິຫານ 4 - 1,900,000</option>
                                <option value="2100000">ບໍລິຫານ 3 - 2,100,000</option>
                                <option value="2300000">ບໍລິຫານ 2 - 2,300,000</option>
                                <option value="2500000">ບໍລິຫານ 1 - 2,500,000</option>
                                <option value="3000000">ການນຳ 6/1 - 3,000,000</option>
                                <option value="4000000">ການນຳ 6/2 - 4,000,000</option>
                                <option value="5000000">ການນຳ 6/3 - 5,000,000</option>
                                <option value="6000000">ການນຳ 6/4 - 6,000,000</option>
                                <option value="7000000">ການນຳ 6/5 - 7,000,000</option>
                                <option value="8000000">ການນຳ 6/6 - 8,000,000</option>
                                <option value="9000000">ການນຳ 6/7 - 9,000,000</option>
                            </select>
                        </div>
                    </div>

                    <!-- Teacher Allowance (Dynamic Display) -->
                    <div class="card hidden" id="teacherSection">
                        <div class="card-header">
                            <i class="fas fa-school"></i>
                            <span class="card-title">ອຸດໜູນອາຊີບຄູ</span>
                        </div>
                        <div class="form-grid">
                            <div class="form-group full">
                                <label>ເປີເຊັນອຸດໜູນ (%)</label>
                                <select id="teacherPercent">
                                    <option value="0">0% (ບໍ່ໄດ້ຮັບ)</option>
                                    <option value="10">10%</option>
                                    <option value="15">15%</option>
                                    <option value="20">20%</option>
                                    <option value="25">25%</option>
                                    <option value="30">30%</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ສອນຫ້ອງຄວບ</label>
                                <!-- FIXED: Input restricted to numbers only -->
                                <input type="tel" id="combinedClass" placeholder="0" class="money-input" inputmode="numeric">
                            </div>
                            <div class="form-group">
                                <label>ຕຳແໜ່ງວິຊາການຄູ</label>
                                <!-- FIXED: Input restricted to numbers only -->
                                <input type="tel" id="technicalTeacher" placeholder="0" class="money-input" inputmode="numeric">
                            </div>
                            <div class="form-group full">
                                <label>ຕາມຜົນປະເມີນ</label>
                                <!-- FIXED: Input restricted to numbers only -->
                                <input type="tel" id="performance" placeholder="0" class="money-input" inputmode="numeric">
                            </div>
                        </div>
                    </div>

                    <!-- Other Allowances -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-coins"></i>
                            <span class="card-title">ເງິນອຸດໜູນ & ນະໂຍບາຍ</span>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>ຫ່າງໄກສອກຫຼີກ</label>
                                <!-- FIXED: Input restricted to numbers only -->
                                <input type="tel" id="remoteAllowance" placeholder="0" class="money-input" inputmode="numeric">
                            </div>
                            <div class="form-group">
                                <label>ເງິນທາດເບື່ອ</label>
                                <!-- FIXED: Input restricted to numbers only -->
                                <input type="tel" id="toxicAllowance" placeholder="0" class="money-input" inputmode="numeric">
                            </div>
                            <div class="form-group">
                                <label>ນະໂຍບາຍຊ່ວຍໜູນ</label>
                                <!-- FIXED: Input restricted to numbers only -->
                                <input type="tel" id="policySupport" placeholder="0" class="money-input" inputmode="numeric">
                            </div>
                            <div class="form-group">
                                <label>ອໜ ສະມາຊິກສະພາ</label>
                                <!-- FIXED: Input restricted to numbers only -->
                                <input type="tel" id="assemblyAllowance" placeholder="0" class="money-input" inputmode="numeric">
                            </div>
                        </div>
                    </div>

                    <!-- Family -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-users"></i>
                            <span class="card-title">ຄອບຄົວ</span>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>ຈຳນວນລູກ (≤18ປີ)</label>
                                <!-- FIXED: Input restricted to numbers only -->
                                <input type="tel" id="childCount" value="0" inputmode="numeric" class="money-input">
                            </div>
                            <div class="form-group">
                                <label>ຄູ່ສົມລົດ</label>
                                <select id="spouse">
                                    <option value="0">ບໍ່ມີ</option>
                                    <option value="200000">ມີ (200,000 ກີບ)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="btn btn-reset" onclick="resetForm(true)">
                            <i class="fas fa-redo"></i> ລ້າງ
                        </button>
                        <button class="btn btn-calc" onclick="handleCalculate()">
                            <i class="fas fa-calculator"></i> ຄຳນວນ
                        </button>
                    </div>
                    <div style="height: 20px;"></div>
            </form>
        </div>

        <!-- PAGE 3: PENSION CALCULATOR -->
        <div id="page-pension" class="page">
            <div class="home-info-box" style="background: #efebe9; border-color: #795548; color: #5d4037;">
                <i class="fas fa-blind"></i> ທ່ານພວມຢູ່ໃນໂຫມດ: <strong>ຄຳນວນບຳນານ (Pension)</strong>
            </div>

            <form id="pensionForm" onsubmit="return false;">
                <!-- Personal Info -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-user"></i>
                        <span class="card-title">ຂໍ້ມູນທົ່ວໄປ</span>
                    </div>
                    <div class="form-group">
                        <label class="required">ຊື່ ແລະ ນາມສະກຸນ</label>
                        <input type="text" id="p_fullName" placeholder="ປ້ອນຊື່..." required>
                    </div>
                </div>

                <!-- Position & Index -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-briefcase"></i>
                        <span class="card-title">ຂໍ້ມູນເງິນເດືອນ & ປີການ</span>
                    </div>
                    
                    <div class="form-group">
                        <label>ເງິນຕຳແໜ່ງ</label>
                        <select id="p_positionMoney">
                            <option value="9000000">ການນຳ 6/7 - 9,000,000</option>
                            <option value="8000000">ການນຳ 6/6 - 8,000,000</option>
                            <option value="7000000">ການນຳ 6/5 - 7,000,000</option>
                            <option value="6000000">ການນຳ 6/4 - 6,000,000</option>
                            <option value="5000000">ການນຳ 6/3 - 5,000,000</option>
                            <option value="4000000">ການນຳ 6/2 - 4,000,000</option>
                            <option value="3000000">ການນຳ 6/1 - 3,000,000</option>
                            <option value="2500000">ບໍລິຫານ 1 - 2,500,000</option>
                            <option value="2300000">ບໍລິຫານ 2 - 2,300,000</option>
                            <option value="2100000">ບໍລິຫານ 3 - 2,100,000</option>
                            <option value="1900000">ບໍລິຫານ 4 - 1,900,000</option>
                            <option value="1700000">ບໍລິຫານ 5 - 1,700,000</option>
                            <option value="1500000">ບໍລິຫານ 6 - 1,500,000</option>
                            <option value="1300000">ບໍລິຫານ 7 - 1,300,000</option>
                            <option value="1100000">ບໍລິຫານ 8 - 1,100,000</option>
                            <option value="900000">ວິຊາການ - 900,000</option>
                            <option value="0" selected>ພະນັກງານ 95 / ບໍ່ມີ - 0</option>
                        </select>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">ຊັ້ນ</label>
                            <select id="p_classSelect" onchange="updateLevelsPension()" required>
                                <option value="">ເລືອກ...</option>
                                <option value="1">ຊັ້ນ 1</option>
                                <option value="2">ຊັ້ນ 2</option>
                                <option value="3">ຊັ້ນ 3</option>
                                <option value="4">ຊັ້ນ 4</option>
                                <option value="5">ຊັ້ນ 5</option>
                                <option value="6">ຊັ້ນ 6</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="required">ຂັ້ນ</label>
                            <select id="p_levelSelect" onchange="updateIndexPension()" required disabled>
                                <option value="">...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ດັດສະນີ (Auto)</label>
                            <input type="text" id="p_indexDisplay" readonly placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="required">ປີການ (1-50 ປີ)</label>
                            <!-- FIXED: Input restricted to numbers only -->
                            <input type="tel" id="p_yearsService" value="0" inputmode="numeric" class="money-input">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>ອຸດໜູນອາຊີບ (ຖ້າມີ)</label>
                        <!-- FIXED: Input restricted to numbers only -->
                        <input type="tel" id="p_occAllowance" placeholder="0" class="money-input" inputmode="numeric">
                    </div>
                </div>

                <!-- Pension Rate -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-percent"></i>
                        <span class="card-title">ອັດຕາສ່ວນບຳນານ</span>
                    </div>
                    <div class="form-group">
                        <label class="required">ເປີເຊັນບຳນານ (%)</label>
                        <!-- FIXED: Input restricted to numbers only -->
                        <input type="tel" id="p_pensionPercent" placeholder="ເຊັ່ນ: 75, 80, 100..." required inputmode="numeric" class="money-input">
                        <small style="color:#78909c;">ໃສ່ແຕ່ຕົວເລກ (ບໍ່ຕ້ອງໃສ່ %)</small>
                    </div>
                </div>

                <!-- Family -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-users"></i>
                        <span class="card-title">ຄອບຄົວ (ອຸດໜູນລູກ)</span>
                    </div>
                    <div class="form-group">
                        <label>ຈຳນວນລູກ (≤18ປີ)</label>
                        <!-- FIXED: Input restricted to numbers only -->
                        <input type="tel" id="p_childCount" value="0" inputmode="numeric" class="money-input">
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-reset" onclick="resetForm(true)">
                        <i class="fas fa-redo"></i> ລ້າງ
                    </button>
                    <button class="btn btn-calc" onclick="calculatePension()">
                        <i class="fas fa-calculator"></i> ຄຳນວນບຳນານ
                    </button>
                </div>
                <div style="height: 20px;"></div>
            </form>
        </div>

        <!-- PAGE 4: ALLOWANCE (NEW TAB) -->
        <div id="page-allowance" class="page">
            <div class="home-info-box" style="background: #ede7f6; border-color: #673ab7; color: #512da8;">
                <i class="fas fa-hand-holding-heart"></i> ທ່ານພວມຢູ່ໃນໂຫມດ: <strong>ຄຳນວນເງິນອຸດໜູນ (Allowance)</strong>
            </div>

            <form id="allowanceForm" onsubmit="return false;">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-user"></i>
                        <span class="card-title">ຂໍ້ມູນທົ່ວໄປ</span>
                    </div>
                    <div class="form-group">
                        <label class="required">ຊື່ ແລະ ນາມສະກຸນ</label>
                        <input type="text" id="a_fullName" placeholder="ປ້ອນຊື່..." required>
                    </div>
                    <div class="form-group">
                        <label class="required">ເນື້ອໃນເງິນອຸດໜູນ</label>
                        <select id="a_allowanceType" onchange="toggleAllowancePercent()" required>
                            <option value="">ເລືອກປະເພດ...</option>
                            <option value="ບຳເນັດອອກການ">ບຳເນັດອອກການ</option>
                            <option value="ເງິນເສຍຊີວິດລັດຖະກອນ">ເງິນເສຍຊີວິດລັດຖະກອນ</option>
                            <option value="ເງິນເສຍຊີວິດຜົວຫຼືເມຍລັດຖະກອນ">ເງິນເສຍຊີວິດຜົວຫຼືເມຍລັດຖະກອນ</option>
                            <option value="ເງິນເສຍຊີວິດລູກລັດຖະກອນ">ເງິນເສຍຊີວິດລູກລັດຖະກອນ</option>
                            <option value="ເງິນເສຍຊີວິດບຳນານ">ເງິນເສຍຊີວິດບຳນານ</option>
                            <option value="ເງິນເສຍຊີວິດຜົວຫຼືເມຍບຳນານ">ເງິນເສຍຊີວິດຜົວຫຼືເມຍບຳນານ</option>
                            <option value="ເງິນເສຍຊີວິດລູກ ບຳນານ">ເງິນເສຍຊີວິດລູກບຳນານ</option>
                            <option value="ເງິນເສຍຊີວິດໝ້າຍ">ເງິນເສຍຊີວິດໝ້າຍ</option>
                        </select>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-calculator"></i>
                        <span class="card-title">ຂໍ້ມູນຄຳນວນ</span>
                    </div>
                    
                    <!-- UPDATED: Position Money (Editable + List) -->
                    <div class="form-group">
                        <label>ເງິນຕຳແໜ່ງ (ປ້ອນເອງໄດ້)</label>
                        <div style="position: relative;">
                            <input type="tel" id="a_positionMoney" class="money-input" placeholder="ເລືອກ ຫຼື ປ້ອນຈຳນວນເງິນ..." list="a_position_datalist">
                            <datalist id="a_position_datalist">
                                <option value="9,000,000">ການນຳ 6/7</option>
                                <option value="8,000,000">ການນຳ 6/6</option>
                                <option value="7,000,000">ການນຳ 6/5</option>
                                <option value="6,000,000">ການນຳ 6/4</option>
                                <option value="5,000,000">ການນຳ 6/3</option>
                                <option value="4,000,000">ການນຳ 6/2</option>
                                <option value="3,000,000">ການນຳ 6/1</option>
                                <option value="2,500,000">ບໍລິຫານ 1</option>
                                <option value="2,300,000">ບໍລິຫານ 2</option>
                                <option value="2,100,000">ບໍລິຫານ 3</option>
                                <option value="1,900,000">ບໍລິຫານ 4</option>
                                <option value="1,700,000">ບໍລິຫານ 5</option>
                                <option value="1,500,000">ບໍລິຫານ 6</option>
                                <option value="1,300,000">ບໍລິຫານ 7</option>
                                <option value="1,100,000">ບໍລິຫານ 8</option>
                                <option value="900,000">ວິຊາການ</option>
                                <option value="0">ບໍ່ມີ</option>
                            </datalist>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">ຊັ້ນ</label>
                            <select id="a_classSelect" onchange="updateLevelsAllowance()" required>
                                <option value="">ເລືອກ...</option>
                                <option value="1">ຊັ້ນ 1</option>
                                <option value="2">ຊັ້ນ 2</option>
                                <option value="3">ຊັ້ນ 3</option>
                                <option value="4">ຊັ້ນ 4</option>
                                <option value="5">ຊັ້ນ 5</option>
                                <option value="6">ຊັ້ນ 6</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="required">ຂັ້ນ</label>
                            <select id="a_levelSelect" onchange="updateIndexAllowance()" required disabled>
                                <option value="">...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ດັດສະນີ (Auto)</label>
                            <input type="text" id="a_indexDisplay" readonly placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="required">ປີການ (1-50)</label>
                            <!-- FIXED: Input restricted to numbers only -->
                            <input type="tel" id="a_yearsService" value="0" inputmode="numeric" class="money-input">
                        </div>
                    </div>
                </div>

                <!-- Box 10: Percentage (Conditional) -->
                <div class="card hidden" id="a_percentCard">
                    <div class="card-header">
                        <i class="fas fa-percentage"></i>
                        <span class="card-title" id="a_percentTitle">ເປີເຊັນບຳເນັດ/ບຳນານ</span>
                    </div>
                    <div class="form-group">
                        <label class="required">ລະບຸເປີເຊັນ (%)</label>
                        <!-- FIXED: Input restricted to numbers only -->
                        <input type="tel" id="a_percentBox10" placeholder="ເຊັ່ນ: 75, 80..." class="money-input" inputmode="numeric">
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-reset" onclick="resetForm(true)">
                        <i class="fas fa-redo"></i> ລ້າງ
                    </button>
                    <button class="btn btn-calc" onclick="calculateAllowance()">
                        <i class="fas fa-calculator"></i> ຄຳນວນອຸດໜູນ
                    </button>
                </div>
                <div style="height: 20px;"></div>
            </form>
        </div>

    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home')" id="nav-home">
            <i class="fas fa-home"></i>
            <span>ໜ້າຫຼັກ</span>
        </div>
        <div class="nav-item" onclick="switchTab('civil')" id="nav-civil">
            <i class="fas fa-user-tie"></i>
            <span>ລັດຖະກອນ</span>
        </div>
        <div class="nav-item" onclick="switchTab('teacher')" id="nav-teacher">
            <i class="fas fa-chalkboard-teacher"></i>
            <span>ຄູ</span>
        </div>
        <div class="nav-item" onclick="switchTab('pension')" id="nav-pension">
            <i class="fas fa-blind"></i>
            <span>ບຳນານ</span>
        </div>
        <div class="nav-item" onclick="switchTab('allowance')" id="nav-allowance">
            <i class="fas fa-hand-holding-heart"></i>
            <span>ອຸດໜູນ</span>
        </div>
    </nav>

    <!-- Slip Modal (Detailed Version) -->
    <div class="modal-overlay" id="slipModal">
        <div class="modal-content">
            <div class="slip-paper" id="salarySlip">
                
                <!-- Official Header -->
                <div class="slip-header-official">
                    <h4>ສາທາລະນະລັດ ປະຊາທິປະໄຕ ປະຊາຊົນລາວ</h4>
                    <h4>ສັນຕິພາບ ເອກະລາດ ປະຊາທິປະໄຕ ເອກະພາບ ວັດທະນະຖາວອນ</h4>
                    <div class="slip-divider-line"></div>
                    <h3 id="slipTitle">ໃບບິນເງິນເດືອນ</h3>
                </div>

                <div class="slip-meta">
                    <div class="slip-meta-row">
                        <span>ວັນທີອອກບິນ:</span>
                        <span class="val" id="slipDate">dd/mm/yyyy</span>
                    </div>
										
                    <div class="slip-meta-row">
                        <span>ຊື່ ແລະ ນາມສະກຸນ:</span>
                        <span id="resName" style="font-family:'Noto Sans Lao',sans-serif;font-weight:400;">
                            ...
                        </span>
                    </div>
				
                    <div class="slip-meta-row">
                        <span>ຕຳແໜ່ງ/ຊັ້ນ-ຂັ້ນ:</span>
                        <span><span id="resClassLevel"></span> (ດັດສະນີ: <span id="resIndex" class="val"></span>)</span>
                    </div>

                    <!-- New Row for Allowance Type -->
                    <div class="slip-meta-row hidden" id="resAllowanceTypeRow">
                        <span>ປະເພດອຸດໜູນ:</span>
                        <span id="resAllowanceType" style="font-weight:600; color:var(--allowance);"></span>
                    </div>
                </div>

                <!-- 1. Income Section -->
                <div class="slip-section-title">1. ລາຍຮັບ (Income)</div>
                <div class="slip-item">
                    <span>ເງິນເດືອນພື້ນຖານ (Base):</span>
                    <span class="val" id="resBase">0</span>
                </div>
                <div class="slip-item">
                    <span>ເງິນດັດສົມປີການ (Years):</span>
                    <span class="val" id="resYear">0</span>
                </div>
                <div class="slip-item">
                    <span>ເງິນຕຳແໜ່ງ (Position):</span>
                    <span class="val" id="resPosition">0</span>
                </div>
                
                <!-- Teacher specific items -->
                <div id="resTeacherBlock" class="hidden">
                    <div class="slip-item sub">
                        <span>+ ອຸດໜູນຄູ (<span id="resTeacherPct">0</span>%):</span>
                        <span class="val" id="resTeacherMoney">0</span>
                    </div>
                    <div class="slip-item sub">
                        <span>+ ສອນຫ້ອງຄວບ:</span>
                        <span class="val" id="resCombined">0</span>
                    </div>
                    <div class="slip-item sub">
                        <span>+ ວິຊາການຄູ:</span>
                        <span class="val" id="resTechTeacher">0</span>
                    </div>
                    <div class="slip-item sub">
                        <span>+ ຜົນການປະເມີນ:</span>
                        <span class="val" id="resPerform">0</span>
                    </div>
                </div>

                <!-- Civil Allowances -->
                <div id="resCivilBlock">
                    <div class="slip-item">
                        <span>ອຸດໜູນຫ່າງໄກສອກຫຼີກ:</span>
                        <span class="val" id="resRemote">0</span>
                    </div>
                    <div class="slip-item">
                        <span>ອຸດໜູນອື່ນໆ (ທາດເບື່ອ/ສະພາ):</span>
                        <span class="val" id="resOtherAllow">0</span>
                    </div>
                </div>

                <!-- Pension Specific Block -->
                <div id="resPensionBlock" class="hidden">
                    <div class="slip-item">
                        <span>ອຸດໜູນອາຊີບ:</span>
                        <span class="val" id="resOccAllow">0</span>
                    </div>
                    <div class="slip-item total-sub" style="margin-top:5px; border-top:1px dashed #ccc;">
                        <span>ລວມເງິນກ່ອນຄິດໄລ່ເປີເຊັນ:</span>
                        <span class="val" id="resPensionBaseTotal">0</span>
                    </div>
                    <div class="slip-item" style="color:var(--pension); font-weight:600;">
                        <span>ຄິດໄລ່ບຳນານ (<span id="resPensionPctDisplay">0</span>%):</span>
                        <span class="val" id="resPensionFinal">0</span>
                    </div>
                </div>

                <!-- ALLOWANCE SPECIFIC BLOCK (NEW) -->
                <div id="resAllowanceBlock" class="hidden">
                    <div class="slip-item total-sub" style="margin-top:5px; border-top:1px dashed #ccc;">
                        <span>ລວມເງິນກ່ອນຄິດໄລ່ (<span id="resAllowancePctDisplay"></span>):</span>
                        <span class="val" id="resAllowancePreTotal">0</span>
                    </div>
                    <div class="slip-item">
                        <span>ຈຳນວນເດືອນທີ່ໄດ້ຮັບ:</span>
                        <span class="val" id="resAllowanceMonths">0</span>
                    </div>
                    <div class="slip-item" id="resAllowanceYearsRow">
                        <span>ຄູນຈຳນວນປີການ:</span>
                        <span class="val" id="resAllowanceYearMult">0</span>
                    </div>
                </div>

                <!-- Total Gross (Hidden for Pension Mode as logic differs) -->
                <div class="slip-item total-sub" id="grossTotalRow" style="margin-top:10px;">
                    <span>ລວມຍອດລາຍຮັບ:</span>
                    <span class="val plus" id="resTotalGross">0</span>
                </div>

                <!-- 2. Deductions -->
                <div class="slip-section-title" id="deductionTitle">2. ພັນທະ & ອາກອນ (Deductions)</div>
                
                <!-- Normal Mode Deductions -->
                <div id="normalDeductions">
                    <div class="slip-item">
                        <span>ຫັກປະກັນສັງຄົມ (8%):</span>
                        <span class="val minus">-<span id="resSocial">0</span></span>
                    </div>
                    <div class="slip-item">
                        <span>ຫັກອາກອນເງິນເດືອນ:</span>
                        <span class="val minus">-<span id="resTax">0</span></span>
                    </div>
                </div>

                <!-- Pension Deductions -->
                <div id="pensionDeductions" class="hidden">
                     <div class="slip-item">
                        <span>ຫັກປະກັນສຸຂະພາບ (0.625%):</span>
                        <span class="val minus">-<span id="resHealth">0</span></span>
                    </div>
                </div>

                <div class="slip-item total-sub" id="totalDeductRow">
                    <span>ລວມຍອດຫັກ:</span>
                    <span class="val minus">-<span id="resTotalDeduct">0</span></span>
                </div>

                <!-- 3. Family/Welfare -->
                <div class="slip-section-title" id="welfareTitle">3. ເງິນນະໂຍບາຍ (Welfare)</div>
                <div class="slip-item" id="resChildRow">
                    <span>ເງິນລູກ (<span id="resChildCount">0</span> ຄົນ):</span>
                    <span class="val" id="resChildMoney">0</span>
                </div>
                
                <!-- Normal Only -->
                <div id="normalWelfare">
                    <div class="slip-item">
                        <span>ເງິນຄູ່ສົມລົດ:</span>
                        <span class="val" id="resSpouse">0</span>
                    </div>
                    <div class="slip-item">
                        <span>ເງິນນະໂຍບາຍຊ່ວຍໜູນ:</span>
                        <span class="val" id="resPolicy">0</span>
                    </div>
                </div>

                <!-- Pension Welfare -->
                <div id="pensionWelfare" class="hidden">
                    <div class="slip-item">
                        <span>ເງິນນະໂຍບາຍຊ່ວຍໜູນ (3ລ້ານ):</span>
                        <span class="val" id="resPensionSubsidy">0</span>
                    </div>
                </div>

                <!-- Grand Total -->
                <div class="slip-grand-total">
                    <div class="label" id="grandTotalLabel">ເງິນເດືອນຮັບສຸດທິ (Net Salary)</div>
                    <div class="amount"><span id="resNetSalary">0</span> <span style="font-size:1rem; font-weight:400;">ກີບ</span></div>
                </div>
                
                <div class="slip-footer">
                    Created by IT BANBAN Salary System 2026<br>
                    (ໃບບິນນີ້ສ້າງຂຶ້ນຈາກລະບົບຄຳນວນເບື້ອງຕົ້ນ)
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-close" onclick="closeModal()">ປິດ</button>
                <button class="btn btn-save" onclick="downloadImage()">ບັນທຶກຮູບ</button>
            </div>
        </div>
    </div>

    <script>
        // --- Visitor Counter Script (New) ---
         const scriptURL = "https://script.google.com/macros/s/AKfycbyzNHgc0Jf7XMLb0RZzSBteUlZWbob1NwaVtMQC51ikg5tk4P1_Y3rpad0X8WQNs1DtlQ/exec";

        function fetchVisitorCount() {
            fetch(scriptURL)
                .then(res => res.json())
                .then(data => {
                    const count = data.total || 0;
                    document.getElementById('visitor-text').innerText = `ຈຳນວນຜູ້ເຂົ້າຊົມ : ${count.toLocaleString()} ຄົນ`;
                })
                .catch(err => {
                    console.error("Counter Error", err);
                    document.getElementById('visitor-text').innerText = "Visitor Count Error";
                });
        }

        // --- Data ---
        const indexTable = {
            '1': [260, 261, 262, 263, 264, 265, 266, 267, 268, 269, 270, 271, 272, 273, 274],
            '2': [268, 269, 270, 271, 272, 273, 274, 275, 276, 277, 278, 279, 280, 281, 282],
            '3': [276, 277, 278, 279, 280, 281, 282, 284, 286, 288, 290, 292, 294, 296, 298],
            '4': [286, 288, 290, 292, 294, 296, 298, 303, 308, 313, 318, 323, 328, 333, 338],
            '5': [308, 313, 318, 323, 328, 333, 338, 348, 358, 368, 378, 388, 398, 408, 418],
            '6': [600, 700, 800, 900, 1000, 1100, 1200]
        };

        // Current State
        let currentMode = 'civil'; // 'civil', 'teacher', 'pension', 'allowance'
        let deferredPrompt;

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            // Load Visitor Count
            fetchVisitorCount();

            // Input formatting and Validation (Restricts to numbers)
            document.querySelectorAll('.money-input').forEach(input => {
                input.addEventListener('input', function(e) {
                    // Force remove any non-numeric characters immediately
                    this.value = this.value.replace(/[^0-9]/g, '');
                    formatCurrencyInput(this);
                });
            });
            
            // Register Service Worker
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    // Try catch to prevent error in preview environment
                    try {
                        navigator.serviceWorker.register('./service-worker.js')
                            .then(reg => console.log('SW Registered!', reg))
                            .catch(err => console.log('SW Failed', err));
                    } catch(e) {}
                });
            }
            
            // Install Prompt Logic
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('install-prompt').style.display = 'flex';
            });
        });

        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('install-prompt').style.display = 'none';
                }
                deferredPrompt = null;
            }
        }

        // --- Tab Switching Logic (WITH AUTO RESET) ---
        function switchTab(tabName) {
            // Update Active Nav Item
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${tabName}`).classList.add('active');

            // Hide all pages first
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.body.classList.remove('pension-mode');
            document.body.classList.remove('allowance-mode');

            const headerTitle = document.getElementById('headerTitle');
            const teacherSection = document.getElementById('teacherSection');
            const teacherBanner = document.getElementById('teacherModeBanner');

            // AUTO RESET
            resetForm(true);

            if (tabName === 'home') {
                document.getElementById('page-home').classList.add('active');
                headerTitle.textContent = "IT-BANBAN";
            } else if (tabName === 'pension') {
                currentMode = 'pension';
                document.getElementById('page-pension').classList.add('active');
                headerTitle.textContent = "ຄຳນວນບຳນານ";
                document.body.classList.add('pension-mode');
            } else if (tabName === 'allowance') {
                currentMode = 'allowance';
                document.getElementById('page-allowance').classList.add('active');
                headerTitle.textContent = "ຄຳນວນເງິນອຸດໜູນ";
                document.body.classList.add('allowance-mode');
            } else {
                // Show Calculator Page (Civil/Teacher)
                document.getElementById('page-calc').classList.add('active');
                
                if (tabName === 'teacher') {
                    currentMode = 'teacher';
                    headerTitle.textContent = "ຄຳນວນເງິນເດືອນຄູ";
                    teacherSection.classList.remove('hidden');
                    teacherBanner.classList.remove('hidden');
                } else {
                    currentMode = 'civil';
                    headerTitle.textContent = "ຄຳນວນລັດຖະກອນ";
                    teacherSection.classList.add('hidden');
                    teacherBanner.classList.add('hidden');
                }
            }
        }

        // --- Helpers for Pension Form ---
        function updateLevelsPension() {
            const cls = document.getElementById('p_classSelect').value;
            const levelSelect = document.getElementById('p_levelSelect');
            levelSelect.innerHTML = '<option value="">...</option>';
            
            if (cls) {
                const levels = indexTable[cls].length;
                for(let i=1; i<=levels; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = `ຂັ້ນ ${i}`;
                    levelSelect.appendChild(opt);
                }
                levelSelect.disabled = false;
            } else {
                levelSelect.disabled = true;
                document.getElementById('p_indexDisplay').value = '';
            }
        }

        function updateIndexPension() {
            const cls = document.getElementById('p_classSelect').value;
            const lvl = document.getElementById('p_levelSelect').value;
            if (cls && lvl) {
                document.getElementById('p_indexDisplay').value = indexTable[cls][lvl-1];
            }
        }

        // --- Helpers for Allowance Form ---
        function updateLevelsAllowance() {
            const cls = document.getElementById('a_classSelect').value;
            const levelSelect = document.getElementById('a_levelSelect');
            levelSelect.innerHTML = '<option value="">...</option>';
            
            if (cls) {
                const levels = indexTable[cls].length;
                for(let i=1; i<=levels; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = `ຂັ້ນ ${i}`;
                    levelSelect.appendChild(opt);
                }
                levelSelect.disabled = false;
            } else {
                levelSelect.disabled = true;
                document.getElementById('a_indexDisplay').value = '';
            }
        }

        function updateIndexAllowance() {
            const cls = document.getElementById('a_classSelect').value;
            const lvl = document.getElementById('a_levelSelect').value;
            if (cls && lvl) {
                document.getElementById('a_indexDisplay').value = indexTable[cls][lvl-1];
            }
        }

        function toggleAllowancePercent() {
            const type = document.getElementById('a_allowanceType').value;
            const card = document.getElementById('a_percentCard');
            // Logic 10: Show if "ບຳເນັດອອກການ" or implies others like Widow/Pension Death
            // Based on formula logic step 11, we need Box 10 for Widow, Pensioners, and Severance.
            if (type === 'ບຳເນັດອອກການ' || type === 'ເງິນເສຍຊີວິດໝ້າຍ' || type.endsWith('ບຳນານ') || type === 'ເງິນເສຍຊີວິດລູກ ບຳນານ') {
                card.classList.remove('hidden');
                if (type === 'ບຳເນັດອອກການ') document.getElementById('a_percentTitle').textContent = "ເປີເຊັນບຳເນັດ";
                else document.getElementById('a_percentTitle').textContent = "ເປີເຊັນທີ່ໄດ້ຮັບ";
            } else {
                card.classList.add('hidden');
                document.getElementById('a_percentBox10').value = '';
            }
        }

        // --- Helpers for Normal Form ---
        function updateLevels() {
            const cls = document.getElementById('classSelect').value;
            const levelSelect = document.getElementById('levelSelect');
            levelSelect.innerHTML = '<option value="">...</option>';
            
            if (cls) {
                const levels = indexTable[cls].length;
                for(let i=1; i<=levels; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = `ຂັ້ນ ${i}`;
                    levelSelect.appendChild(opt);
                }
                levelSelect.disabled = false;
            } else {
                levelSelect.disabled = true;
                document.getElementById('indexDisplay').value = '';
            }
        }

        function updateIndex() {
            const cls = document.getElementById('classSelect').value;
            const lvl = document.getElementById('levelSelect').value;
            if (cls && lvl) {
                document.getElementById('indexDisplay').value = indexTable[cls][lvl-1];
            }
        }

        function formatCurrencyInput(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value) {
                input.value = parseInt(value).toLocaleString('en-US');
            } else {
                input.value = '';
            }
        }

        function parseFormatted(id) {
            const el = document.getElementById(id);
            if(!el) return 0;
            const val = el.value;
            return parseFloat(val.replace(/,/g, '')) || 0;
        }

        function fmt(num) {
            return Math.round(num).toLocaleString('en-US');
        }

        // --- Allowance Calculation ---
        function calculateAllowance() {
            const fullName = document.getElementById('a_fullName').value;
            const type = document.getElementById('a_allowanceType').value;
            const cls = document.getElementById('a_classSelect').value;
            const lvl = document.getElementById('a_levelSelect').value;
            
            if (!fullName || !type || !cls || !lvl) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ຂໍ້ມູນບໍ່ຄົບຖ້ວນ',
                    text: 'ກະລຸນາປ້ອນຂໍ້ມູນໃຫ້ຄົບຖ້ວນ!',
                    confirmButtonColor: '#673ab7'
                });
                return;
            }

            Swal.fire({
                title: 'ກຳລັງຄຳນວນ...',
                timer: 500,
                didOpen: () => Swal.showLoading()
            }).then(() => {
                // Inputs
                const index = parseFloat(document.getElementById('a_indexDisplay').value);
                const years = parseFloat(document.getElementById('a_yearsService').value) || 0;
                // UPDATED: Use parseFormatted because it's now an input with commas
                const posMoney = parseFormatted('a_positionMoney');
                
                // Box 10 logic
                const box10Val = parseFloat(document.getElementById('a_percentBox10').value) || 0;

                // 7. Base Salary
                const baseSalary = index * 9500;

                // 8. Year Salary
                let yearSalary = 0;
                if (years <= 5) yearSalary = years * 10000;
                else if (years <= 15) yearSalary = 50000 + ((years - 5) * 20000);
                else if (years <= 25) yearSalary = 250000 + ((years - 15) * 30000); 
                else yearSalary = 550000 + ((years - 25) * 40000);

                const totalRaw = posMoney + baseSalary + yearSalary;

                // 11. Total Before Deductions (Logic provided)
                let preDeductionTotal = totalRaw;
                if (type === "ເງິນເສຍຊີວິດໝ້າຍ") {
                    preDeductionTotal = Math.floor(totalRaw * (box10Val / 100));
                } else if (type.endsWith("ບຳນານ") || type === "ເງິນເສຍຊີວິດລູກ ບຳນານ") {
                    preDeductionTotal = Math.floor(totalRaw * (box10Val / 100));
                } else if (type === "ບຳເນັດອອກການ") {
                    preDeductionTotal = Math.floor(totalRaw * (box10Val / 100));
                } else {
                    preDeductionTotal = totalRaw;
                }

                // 12. Months Received
                let months = 0;
                if (type === "ເງິນເສຍຊີວິດຜົວຫຼືເມຍລັດຖະກອນ") months = 6;
                else if (type === "ເງິນເສຍຊີວິດລູກລັດຖະກອນ") months = 3;
                else if (type === "ເງິນເສຍຊີວິດຜົວຫຼືເມຍບຳນານ") months = 6;
                else if (type === "ເງິນເສຍຊີວິດລູກ ບຳນານ" || type === "ເງິນເສຍຊີວິດລູກບຳນານ") months = 3;
                else if (type === "ເງິນເສຍຊີວິດໝ້າຍ") months = 6;
                else if (type === "ບຳເນັດອອກການ") months = 1.5;
                else {
                    // Civil Servant Death or others
                    if (years < 7) months = years + 14;
                    else if (years < 90) months = ((years + 24) / 2) + 5;
                    // Note: formula for years < 90 is (years+24)/2 + 5 from prompt
                }

                // 13. Actual Allowance
                let finalAmount = 0;
                if (type === "ບຳເນັດອອກການ") {
                    finalAmount = (preDeductionTotal * months) * years;
                } else if (type === "ເງິນເສຍຊີວິດໝ້າຍ") {
                    finalAmount = Math.round(preDeductionTotal * 0.3) * months;
                } else {
                    finalAmount = preDeductionTotal * months;
                }

                renderSlip({
                    mode: 'allowance',
                    name: fullName,
                    type: type,
                    cls: cls,
                    lvl: lvl,
                    idx: index,
                    base: baseSalary,
                    year: yearSalary,
                    pos: posMoney,
                    box10: box10Val,
                    preTotal: preDeductionTotal,
                    months: months,
                    years: years, // Needed for Severance logic display
                    net: finalAmount
                });
            });
        }

        // --- Pension Calculation ---
        function calculatePension() {
            // Validation
            const fullName = document.getElementById('p_fullName').value;
            const cls = document.getElementById('p_classSelect').value;
            const lvl = document.getElementById('p_levelSelect').value;
            const pensionPercent = parseFloat(document.getElementById('p_pensionPercent').value);

            if (!fullName || !cls || !lvl || isNaN(pensionPercent)) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ຂໍ້ມູນບໍ່ຄົບຖ້ວນ',
                    text: 'ກະລຸນາປ້ອນຂໍ້ມູນ: ຊື່, ຊັ້ນ-ຂັ້ນ, ແລະ ເປີເຊັນບຳນານ',
                    confirmButtonColor: '#795548'
                });
                return;
            }

            Swal.fire({
                title: 'ກຳລັງຄຳນວນ...',
                timer: 500,
                didOpen: () => Swal.showLoading()
            }).then(() => {
                // Inputs
                const index = parseFloat(document.getElementById('p_indexDisplay').value);
                const years = parseFloat(document.getElementById('p_yearsService').value) || 0;
                const posMoney = parseFloat(document.getElementById('p_positionMoney').value) || 0;
                const occAllowance = parseFormatted('p_occAllowance');
                const childCount = parseFloat(document.getElementById('p_childCount').value) || 0;

                // 1. Base (index * 9500)
                const baseSalary = index * 9500;

                // 2. Year Salary (Formula Provided)
                let yearSalary = 0;
                if (years <= 5) yearSalary = years * 10000;
                else if (years <= 15) yearSalary = 50000 + ((years - 5) * 20000);
                else if (years <= 25) yearSalary = 250000 + ((years - 15) * 30000); 
                else yearSalary = 550000 + ((years - 25) * 40000); 

                // 3. Total Before Deductions (Base + Year + Position + Occ)
                const totalBefore = baseSalary + yearSalary + posMoney + occAllowance;

                // 4. Final Salary (TotalBefore * Percent)
                const finalSalary = totalBefore * (pensionPercent / 100);

                // 5. Health Insurance (0.625%)
                const healthInsurance = finalSalary * (0.625 / 100);

                // 6. Child Allowance
                const childMoney = childCount * 200000;

                // 7. Total Received (Before Subsidy)
                const totalReceived = finalSalary - healthInsurance + childMoney;

                // 8. Subsidy Policy (Minimum Wage Floor 3,000,000)
                let subsidy = 0;
                if (totalReceived < 3000000) {
                    subsidy = 3000000 - totalReceived;
                }

                // 9. Net Salary
                const netSalary = totalReceived + subsidy;

                // --- Render Pension Slip ---
                renderSlip({
                    mode: 'pension',
                    name: fullName,
                    cls: cls,
                    lvl: lvl,
                    idx: index,
                    base: baseSalary,
                    year: yearSalary,
                    pos: posMoney,
                    occ: occAllowance,
                    pensionBase: totalBefore,
                    pct: pensionPercent,
                    finalSal: finalSalary,
                    health: healthInsurance,
                    childCount: childCount,
                    childMoney: childMoney,
                    subsidy: subsidy,
                    net: netSalary
                });
            });
        }

        // --- Normal Calculation ---
        function handleCalculate() {
            const fullName = document.getElementById('fullName').value;
            const cls = document.getElementById('classSelect').value;
            const lvl = document.getElementById('levelSelect').value;

            if (!fullName || !cls || !lvl) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ຂໍ້ມູນບໍ່ຄົບຖ້ວນ',
                    text: 'ກະລຸນາປ້ອນຊື່, ເລືອກຊັ້ນ ແລະ ຂັ້ນ ໃຫ້ຄົບຖ້ວນ!',
                    confirmButtonColor: '#009688'
                });
                return;
            }

            Swal.fire({ title: '...', timer: 500, didOpen: () => Swal.showLoading() }).then(() => {
                performCalculation(fullName, cls, lvl);
            });
        }

        function performCalculation(fullName, cls, lvl) {
            const index = parseFloat(document.getElementById('indexDisplay').value);
            const pct = parseFloat(document.getElementById('percentage').value) || 100;
            const years = parseFloat(document.getElementById('yearsService').value) || 0;
            const posMoney = parseFloat(document.getElementById('positionMoney').value) || 0;
            
            let teacherPct = 0, combined = 0, technical = 0, performance = 0;

            if (currentMode === 'teacher') {
                teacherPct = parseFloat(document.getElementById('teacherPercent').value) || 0;
                combined = parseFormatted('combinedClass');
                technical = parseFormatted('technicalTeacher');
                performance = parseFormatted('performance');
            }

            const remote = parseFormatted('remoteAllowance');
            const toxic = parseFormatted('toxicAllowance');
            const policy = parseFormatted('policySupport');
            const assembly = parseFormatted('assemblyAllowance');
            const childCount = parseFloat(document.getElementById('childCount').value) || 0;
            const spouse = parseFloat(document.getElementById('spouse').value) || 0;

            const baseSalary = (index * 9500) * (pct / 100);
            
            let yearSalary = 0;
            if (years <= 5) yearSalary = years * 10000;
            else if (years <= 15) yearSalary = 50000 + ((years - 5) * 20000);
            else if (years <= 25) yearSalary = 250000 + ((years - 15) * 30000); 
            else yearSalary = 550000 + ((years - 25) * 40000); 

            const teacherAllowance = baseSalary * (teacherPct / 100);
            const totalGross = baseSalary + yearSalary + posMoney + teacherAllowance + combined + technical + performance + remote + toxic + assembly;
            const socialBase = baseSalary + yearSalary + posMoney + teacherAllowance; 
            const socialSecurity = socialBase * 0.08;
            const afterSocial = (totalGross - socialSecurity);
            const taxableIncome = afterSocial - policy;

            let tax = 0;
            let taxBase = taxableIncome;
            if (taxBase <= 1300000) tax = 0;
            else if (taxBase <= 5000000) tax = (taxBase - 1300000) * 0.05;
            else if (taxBase <= 15000000) tax = 185000 + ((taxBase - 5000000) * 0.10);
            else if (taxBase <= 25000000) tax = 1185000 + ((taxBase - 15000000) * 0.15);
            else if (taxBase <= 65000000) tax = 2685000 + ((taxBase - 25000000) * 0.20);
            else tax = 10685000 + ((taxBase - 65000000) * 0.25);

            const childMoney = childCount * 200000;
            const familyTotal = childMoney + spouse;
            const netSalary = (taxableIncome - tax) + policy + familyTotal;

            renderSlip({
                mode: currentMode,
                name: fullName,
                cls: cls,
                lvl: lvl,
                idx: index,
                base: baseSalary,
                year: yearSalary,
                pos: posMoney,
                remote: remote,
                other: toxic + assembly,
                teacherPct: teacherPct,
                teacherMoney: teacherAllowance,
                combined: combined,
                techTeacher: technical,
                perform: performance,
                gross: totalGross,
                social: socialSecurity,
                tax: tax,
                deduct: socialSecurity + tax,
                childCount: childCount,
                childMoney: childMoney,
                spouse: spouse,
                policy: policy,
                net: netSalary
            });
        }

        // --- Render Slip (Universal) ---
        function renderSlip(data) {
            const d = new Date();
            document.getElementById('slipDate').textContent = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
            document.getElementById('resName').textContent = data.name;
            document.getElementById('resClassLevel').textContent = `ຊັ້ນ ${data.cls} ຂັ້ນ ${data.lvl}`;
            document.getElementById('resIndex').textContent = data.idx;

            // Common Income
            document.getElementById('resBase').textContent = fmt(data.base);
            document.getElementById('resYear').textContent = fmt(data.year);
            document.getElementById('resPosition').textContent = fmt(data.pos);

            // Visibility Toggles
            const teacherBlock = document.getElementById('resTeacherBlock');
            const civilBlock = document.getElementById('resCivilBlock');
            const pensionBlock = document.getElementById('resPensionBlock');
            const allowanceBlock = document.getElementById('resAllowanceBlock');
            
            const grossRow = document.getElementById('grossTotalRow');
            const normalDeductions = document.getElementById('normalDeductions');
            const pensionDeductions = document.getElementById('pensionDeductions');
            
            const normalWelfare = document.getElementById('normalWelfare');
            const pensionWelfare = document.getElementById('pensionWelfare');
            const childRow = document.getElementById('resChildRow');
            
            const allowanceTypeRow = document.getElementById('resAllowanceTypeRow');

            if (data.mode === 'allowance') {
                document.getElementById('slipTitle').textContent = "ໃບບິນເງິນອຸດໜູນ";
                document.getElementById('grandTotalLabel').textContent = "ຍອດຮັບເງິນອຸດໜູນ (Net Allowance)";
                
                teacherBlock.classList.add('hidden');
                civilBlock.classList.add('hidden');
                pensionBlock.classList.add('hidden');
                allowanceBlock.classList.remove('hidden');
                
                grossRow.classList.remove('hidden'); // Used to show Total Gross (Pre calculation) if needed, or hide
                grossRow.classList.add('hidden'); // Hide for Allowance, using custom block
                
                // Hide Deductions/Welfare sections completely
                document.getElementById('deductionTitle').classList.add('hidden');
                document.getElementById('welfareTitle').classList.add('hidden');
                normalDeductions.classList.add('hidden');
                pensionDeductions.classList.add('hidden');
                document.getElementById('totalDeductRow').classList.add('hidden');
                childRow.classList.add('hidden');
                normalWelfare.classList.add('hidden');
                pensionWelfare.classList.add('hidden');

                // Allowance Type Row
                allowanceTypeRow.classList.remove('hidden');
                document.getElementById('resAllowanceType').textContent = data.type;

                // Allowance Block Data
                let pctDisplay = "";
                if (data.box10 > 0) pctDisplay = `ຄິດໄລ່ ${data.box10}%`;
                else pctDisplay = "ເຕັມ 100%";
                
                document.getElementById('resAllowancePctDisplay').textContent = pctDisplay;
                document.getElementById('resAllowancePreTotal').textContent = fmt(data.preTotal);
                document.getElementById('resAllowanceMonths').textContent = data.months;
                
                if (data.type === 'ບຳເນັດອອກການ') {
                    document.getElementById('resAllowanceYearsRow').classList.remove('hidden');
                    document.getElementById('resAllowanceYearMult').textContent = data.years;
                } else {
                    document.getElementById('resAllowanceYearsRow').classList.add('hidden');
                }

            } else if (data.mode === 'pension') {
                document.getElementById('slipTitle').textContent = "ໃບບິນເງິນບຳນານ";
                document.getElementById('grandTotalLabel').textContent = "ເງິນເດືອນຮັບສຸດທິ (Net Salary)";
                allowanceTypeRow.classList.add('hidden');
                
                teacherBlock.classList.add('hidden');
                civilBlock.classList.add('hidden');
                allowanceBlock.classList.add('hidden');
                pensionBlock.classList.remove('hidden');
                grossRow.classList.add('hidden');
                
                document.getElementById('deductionTitle').classList.remove('hidden');
                document.getElementById('welfareTitle').classList.remove('hidden');
                normalDeductions.classList.add('hidden');
                pensionDeductions.classList.remove('hidden');
                document.getElementById('totalDeductRow').classList.remove('hidden');
                
                childRow.classList.remove('hidden');
                normalWelfare.classList.add('hidden');
                pensionWelfare.classList.remove('hidden');

                // Pension Specific Values
                document.getElementById('resOccAllow').textContent = fmt(data.occ);
                document.getElementById('resPensionBaseTotal').textContent = fmt(data.pensionBase);
                document.getElementById('resPensionPctDisplay').textContent = data.pct;
                document.getElementById('resPensionFinal').textContent = fmt(data.finalSal);
                
                // Pension Deductions
                document.getElementById('resHealth').textContent = fmt(data.health);
                document.getElementById('resTotalDeduct').textContent = fmt(data.health);

                // Pension Welfare
                document.getElementById('resChildCount').textContent = data.childCount;
                document.getElementById('resChildMoney').textContent = fmt(data.childMoney);
                document.getElementById('resPensionSubsidy').textContent = fmt(data.subsidy);

            } else {
                document.getElementById('slipTitle').textContent = "ໃບບິນເງິນເດືອນ";
                document.getElementById('grandTotalLabel').textContent = "ເງິນເດືອນຮັບສຸດທິ (Net Salary)";
                allowanceTypeRow.classList.add('hidden');
                
                pensionBlock.classList.add('hidden');
                allowanceBlock.classList.add('hidden');
                civilBlock.classList.remove('hidden');
                grossRow.classList.remove('hidden');
                
                document.getElementById('deductionTitle').classList.remove('hidden');
                document.getElementById('welfareTitle').classList.remove('hidden');
                normalDeductions.classList.remove('hidden');
                pensionDeductions.classList.add('hidden');
                document.getElementById('totalDeductRow').classList.remove('hidden');
                
                childRow.classList.remove('hidden');
                normalWelfare.classList.remove('hidden');
                pensionWelfare.classList.add('hidden');

                // Teacher Check
                if (data.mode === 'teacher') {
                    teacherBlock.classList.remove('hidden');
                    document.getElementById('resTeacherPct').textContent = data.teacherPct;
                    document.getElementById('resTeacherMoney').textContent = fmt(data.teacherMoney);
                    document.getElementById('resCombined').textContent = fmt(data.combined);
                    document.getElementById('resTechTeacher').textContent = fmt(data.techTeacher);
                    document.getElementById('resPerform').textContent = fmt(data.perform);
                } else {
                    teacherBlock.classList.add('hidden');
                }

                // Civil Values
                document.getElementById('resRemote').textContent = fmt(data.remote);
                document.getElementById('resOtherAllow').textContent = fmt(data.other);
                document.getElementById('resTotalGross').textContent = fmt(data.gross);

                // Normal Deductions
                document.getElementById('resSocial').textContent = fmt(data.social);
                document.getElementById('resTax').textContent = fmt(data.tax);
                document.getElementById('resTotalDeduct').textContent = fmt(data.deduct);

                // Normal Welfare
                document.getElementById('resChildCount').textContent = data.childCount;
                document.getElementById('resChildMoney').textContent = fmt(data.childMoney);
                document.getElementById('resSpouse').textContent = fmt(data.spouse);
                document.getElementById('resPolicy').textContent = fmt(data.policy);
            }

            document.getElementById('resNetSalary').textContent = fmt(data.net);
            document.getElementById('slipModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('slipModal').classList.remove('active');
        }

        function resetForm(silent = false) {
            const doReset = () => {
                document.getElementById('salaryForm').reset();
                document.getElementById('pensionForm').reset();
                document.getElementById('allowanceForm').reset();
                
                // Reset Dropdowns UI
                const selects = ['levelSelect', 'p_levelSelect', 'a_levelSelect'];
                selects.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        el.innerHTML = '<option value="">...</option>';
                        el.disabled = true;
                    }
                });
                
                document.getElementById('indexDisplay').value = '';
                document.getElementById('p_indexDisplay').value = '';
                document.getElementById('a_indexDisplay').value = '';
                document.getElementById('a_percentCard').classList.add('hidden');

                // Civil/Teacher Defaults
                if (currentMode === 'civil') {
                    document.getElementById('teacherPercent').value = 0;
                }
                closeModal();
            };

            if (silent) {
                doReset();
            } else {
                Swal.fire({
                    title: 'ລ້າງຂໍ້ມູນ?',
                    text: "ທ່ານຕ້ອງການເລີ່ມຕົ້ນໃໝ່ບໍ?",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'ຕົກລົງ',
                    cancelButtonText: 'ຍົກເລີກ',
                    confirmButtonColor: '#ef5350'
                }).then((result) => {
                    if (result.isConfirmed) {
                        doReset();
                    }
                });
            }
        }

        function downloadImage() {
            const element = document.getElementById("salarySlip");
            Swal.showLoading();
            
            html2canvas(element, { scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Slip_${currentMode}_${Date.now()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                Swal.close();
                
                Swal.fire({
                    icon: 'success',
                    title: 'ບັນທຶກສຳເລັດ!',
                    timer: 1500,
                    showConfirmButton: false
                });
            });
        }
    </script>
</body>

</html>
